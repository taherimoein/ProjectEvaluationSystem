{% load i18n static %}
{% csrf_token %}

{% block head %}
  {% include "parents/head.html" %}
{% endblock %}

<title>سامانه پروژه ها | ارزیابی پروژه</title>
</head>

<body>

  <div class="loading-fixed d-hide">
    <img src="{% static "images/loading.svg" %}" alt="در حال بارگذاری...">
  </div>

  {% block header %}
    {% include "parents/header.html" %}
  {% endblock %}

  <div class="container-fluid">
    <div class="row">

      {% block sidebar %}
        {% include "parents/sidebar.html" %}
      {% endblock %}

      <div class="col-9">
        <div class="row text-right">
          <div class="col-12">
            <div class="blur">
              <h2 class="title_page">ارزیابی پروژه</h2>
              <h4>نام پروژه : {{ThisProject.title}}</h4>
              <br>
              <div class="row">
                <div class="col-12">
                  <div class="alert-section">
                    <div class="alert-message error-message front text-right mb-3">
                      <div class="alert-message-content error-content">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="alert-message-text error-text">
                        </div>
                      </div>
                      <div class="close-message close-error-message">
                        <i class="fas fa-times"></i>
                      </div>
                    </div>
                    <div class="alert-message success-message front text-right mb-3">
                      <div class="alert-message-content success-content">
                        <i class="fas fa-check"></i>
                        <div class="alert-message-text success-text">
                          ارزیابی پروژه با موفقیت ثبت گردید.
                        </div>
                      </div>
                      <div class="close-message close-success-message">
                        <i class="fas fa-times"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <form>


                <div class="form-row">
                  <div class="form-group col-md-5">
                    <label for="input4">اهمیت پروژه<code>*</code></label>
                    <i class="fal fa-info-circle tooltip-arrow" data-toggle="tooltip"
                        data-placement="left" title="تعیین اهمیت پروژه الزامی میباشد."></i>
                    <select id="input4" class="form-control select2-component">
                        <option value="0">انتخاب...</option>
                        <option value="100">اهمیت ویژه</option>
                        <option value="50">اهمیت متوسط</option>
                        <option value="25">کم اهمیت (اهمیت ضعیف)</option>
                        <option value="0">فاقد اهمیت</option>
                    </select>
                  </div>
                </div>

                <br>

                <div class="form-row">
                  <div class="form-group col-md-5">
                    <label for="inputmanage">نظر کارشناس</label>
                    <i class="fal fa-info-circle tooltip-arrow" data-toggle="tooltip"
                        data-placement="left"
                        title="فیلد بایستی به صورت عددی وارد گردد."></i>
                    <input type="number" class="form-control" id="inputmanage">
                  </div>
                </div>

                <br>

                <div class="form-row">
                  <div class="form-group col-md-5">
                    <label for="inputbudje">مبلغ کل بودجه سالیانه شهرستان</label>
                    <i class="fal fa-info-circle tooltip-arrow" data-toggle="tooltip"
                        data-placement="left"
                        title="فیلد بایستی به صورت عددی وارد گردد."></i>
                    <input type="number" class="form-control" id="inputbudje">
                  </div>
                </div>
                


                <button id="submit" type="submit" class="btn btn-primary">ثبت</button>
                <br>
                <br>
              </form>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  {% block footer %}
    {% include "parents/footer.html" %}
  {% endblock %}

  <script src="{% static "js/base-information/workstation.js" %}" type="text/javascript"></script>
  <script src="{% static "js/jalali-to-georgian.js" %}" type="text/javascript"></script>

  <script>

  $("#submit").click(function (e) {
        e.preventDefault();
            $(".blur").addClass('active disable-form');
            $(".loading-fixed").show();

            var projectID = '{{ThisProject.id}}';
            var Bodje = parseInt($('#inputbudje').val());
            var data = {};

            var importanceOfProject = parseInt($("#input4").val());
            var assistantScore = parseInt($("#inputmanage").val());

            data.importance_of_project = {'point': importanceOfProject};
            data.expert_opinion = {'point': assistantScore};
            data.total_amount_of_city_s_annual_budget = Bodje;

            $.ajax(
              {
                  method: 'POST',
                  url: "{% url 'main:ajax_project_evaluation_assistant' %}",
                  data: {
                    project_id: projectID,
                    assessment: JSON.stringify(data),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                  },
                  success: function (json) {
                    if (json.status == "200")
                      {
                          $(".blur").removeClass('active');
                          $(".loading-fixed").hide();
                          $("html, body").animate({
                          scrollTop: $(".alert-section").offset().top - 20
                          }, 1000);
                          $(".alert-message.success-message").show();
                          $(".alert-message.error-message").hide();
                          var redirectURL = '{% url "master_data:project_list_all_page" %}';
                          setTimeout(function () {
                            location.replace(redirectURL);
                          }, 1500)
                      }
                      else {
                          $(".blur").removeClass('active disable-form');
                          $(".loading-fixed").hide();
                          $("html, body").animate({
                          scrollTop: $(".alert-section").offset().top - 20
                          }, 1000);
                          $(".alert-message-text.error-text").html(json.error + ' ' + '(' + json.status + ')');
                          $(".alert-message.error-message").show();
                      }
                  },
                  error: function (json, xhr, status) {
                    console.log(json.error);
                      console.log(status);
                      console.log(xhr);
                      $(".blur").removeClass('active disable-form');
                      $(".loading-fixed").hide();
                      $("html, body").animate({
                          scrollTop: $(".alert-section").offset().top - 20
                      }, 1000);
                      $(".alert-message-text.error-text").html(xhr + ' ' + '(' + status + ')');
                      $(".alert-message.error-message").show();
                  }
              }
            )
  })

  </script>


</body>

</html>