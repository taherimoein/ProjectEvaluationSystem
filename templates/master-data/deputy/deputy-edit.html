{% load i18n static %}
{% csrf_token %}

{% block head %}
    {% include "parents/head.html" %}
{% endblock %}

<title>سامانه نظام پیشنهادها | ویرایش معاونت "{{ThisDeputy.title}}"</title>
</head>

<body>
    <div class="loading-fixed d-hide">
        <img src="{% static "images/loading.svg" %}" alt="در حال بارگذاری...">
    </div>

    {% block header %}
        {% include "parents/header.html" %}
    {% endblock %}

    <div class="container-fluid">
        <div class="row">

            {% block sidebar %}
                {% include "parents/sidebar.html" %}
            {% endblock %}

            <div class="col-9">
                <div class="row text-right">
                    <div class="col-12">
                        <div class="blur">
                            <h2 class="title_page">ویرایش معاونت "{{ThisDeputy.title}}"</h2>
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert-section">
                                        <div class="alert-message error-message front text-right mb-3">
                                            <div class="alert-message-content error-content">
                                                <i class="fas fa-exclamation-circle"></i>
                                                <div class="alert-message-text error-text">
                                                </div>
                                            </div>
                                            <div class="close-message close-error-message">
                                                <i class="fas fa-times"></i>
                                            </div>
                                        </div>
                                        <div class="alert-message success-message front text-right mb-3">
                                            <div class="alert-message-content success-content">
                                                <i class="fas fa-check"></i>
                                                <div class="alert-message-text success-text">
                                                    معاونت با موفقیت ویرایش گردید.
                                                </div>
                                            </div>
                                            <div class="close-message close-success-message">
                                                <i class="fas fa-times"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <form>
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="inputDeputyTitle">عنوان معاونت<code>*</code></label>
                                        <i class="fal fa-info-circle tooltip-arrow" data-toggle="tooltip"
                                            data-placement="left"
                                            title="عنوان معاونت نباید خالی باشد و باید حداکثر تا 255 کاراکتر طول داشته باشد."></i>
                                        <input type="text" class="form-control" id="inputDeputyTitle"
                                            value="{{ThisDeputy.title}}" maxlength="255">
                                    </div>

                                </div>
                                <br>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="alert-message info-message back text-right mb-3">
                                            <div class="alert-message-content info-content">
                                                <i class="fas fa-info-circle"></i>
                                                <div class="alert-message-text info-text d-inline">
                                                    <p class="d-inline">
                                                        وارد کردن حداقل یک مدیریت برای معاونت الزامی میباشد و مدیریت های
                                                        بیشتر اختیاری میباشد.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row-list my-3">
                                    {% for item in Managements %}
                                        <div class="form-row align-items-end mb-3 main-item prev-item" val="{{item.id}}">
                                            <div class="form-group col-md-4">
                                                <label val="management" for="inputManagement-{{forloop.counter}}">مدیریت
                                                    <span class="count">{{forloop.counter}}</span></label><code>*</code>
                                                <i class="fal fa-info-circle tooltip-arrow" data-toggle="tooltip"
                                                    data-placement="left"
                                                    title="در سطر اضافه شده حتما بایستی یک مدیریت نوشته شود. حداکثر طول مجاز عنوان مدیریت 255 کاراکتر میباشد."></i>
                                                <input value="{{item.title}}" type="text" class="form-control"
                                                    id="inputManagement-{{forloop.counter}}" maxlength="255">
                                            </div>
                                            {% if forloop.counter != 1 %}
                                                <div class="form-group col-md-3">
                                                    <span class="remove-row">حذف سطر <i class="far fa-times"></i></span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <button id="addManagement" class="btn btn-secondary">سطر جدید <i
                                                class="far fa-plus"></i></button>
                                    </div>
                                </div>

                                <br>
                                <br>
                                <button id="submit" type="submit" class="btn btn-primary">ویرایش</button>
                                <br>
                                <br>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    {% block footer %}
        {% include "parents/footer.html" %}
    {% endblock %}

    <script src="{% static "js/base-information/deputy.js" %}" type="text/javascript"></script>

    <script>

        //#region Add Remove Item function
        $("#addManagement").click(function (e) {
            e.preventDefault();
            var count = $(".main-item").length + 1;
            $(".row-list").append('' +
                '<div class="form-row align-items-end mb-3 main-item new-item">' +
                '<div class="form-group col-md-4">' +
                '<label val="management" for="inputManagement-' + count + '">مدیریت <span class="count">' + count + '</span></label> ' +
                '<i class="fal fa-info-circle tooltip-arrow" data-toggle="tooltip" data-placement="left" title="در سطر اضافه شده حتما بایستی یک مدیریت نوشته شود. حداکثر طول مجاز عنوان مدیریت 255 کاراکتر میباشد."></i>' +
                '<input type="text" class="form-control" id="inputManagement-' + count + '">' +
                '</div>' +
                '<div class="form-group col-md-3">' +
                '<span class="remove-row">حذف سطر <i class="far fa-times"></i></span>' +
                '</div>' +
                '</div>');
            $('[data-toggle="tooltip"]').tooltip();
        })

        $(document).on('click', '.remove-row', function () {
            var count = $(".row-list > .form-row").length - 1;
            for (item of $(this).parent().parent().nextAll('.form-row')) {
                var count = parseInt($(item).find('.count').text());

                $(item).find('.count').text(' ' + (count - 1).toString());
                $(item).find("label[val='management']").prop('for', 'inputManagement-' + (count - 1).toString());
                $(item).find("input").prop('id', 'inputManagement-' + (count - 1).toString());
            }
            $(this).parent().parent().remove();
        })
        //#endregion

        //#region Record Previous Items
        var prevManagements = [];
        var prevDeputy;
        // var managementPrevIDs = [];
        $(document).ready(function () {
            prevDeputy = '{{ThisDeputy.title}}';
            var managementElements = $(".main-item");
            var prevManagementObj = {};
            for (var item of managementElements) {
                // managementPrevIDs.push($(item).attr('val'));
                prevManagementObj = {};
                prevManagementObj['id'] = $(item).attr('val');
                prevManagementObj['data'] = $(item).find('input').val();
                prevManagements.push(prevManagementObj);
            }
            console.log('prevManagemenents', prevManagements);
            // console.log(managementPrevIDs);
        })
        //#endregion

        //#region Final Action
        $("#submit").click(function (e) {
            e.preventDefault();

            //#region Control Field
            var checks = checkDeputyFnc();
            //#endregion
            if (checks) {
                $(".blur").addClass('active disable-form');
                $(".loading-fixed").show();

                //#region  Preparing Data
                var data = {};
                var deputyID = '{{ThisDeputy.id}}';
                data.id = parseInt(deputyID);
                data.list = [];
                var deputyTitle = $("#inputDeputyTitle").val();
                if (prevDeputy != deputyTitle)
                {
                    var deputy = {};
                    deputy['id'] = parseInt(deputyID);
                    deputy['data'] = deputyTitle;
                    deputy['status'] = 'edit';
                    deputy['field'] = 'deputy';
                    data.list.push(deputy);
                }
                var deputyManagements = [];

                //#region Preparing Deputy Managements
                var deputyManagementElements = $(".prev-item");
                var deputyManagementObj;

                var remainingManagements;

                for (var prevManagement of prevManagements) {
                    remainingManagements = false;
                    deputyManagementObj = {};
                    for (var item of deputyManagementElements) {
                        if ($(item).attr('val') == prevManagement['id']) {
                            remainingManagements = true;
                            if ($(item).find("input").first().val() != prevManagement['data']) {
                                deputyManagementObj['id'] = parseInt($(item).attr('val'));
                                deputyManagementObj['data'] = $(item).find("input").first().val();
                                deputyManagementObj['status'] = 'edit';
                                deputyManagementObj['field'] = 'management';
                                deputyManagements.push(deputyManagementObj);
                                break;
                            }
                        }
                    }
                    if (!remainingManagements) {
                        deputyManagementObj['id'] = parseInt(prevManagement['id']);
                        deputyManagementObj['data'] = prevManagement['data'];
                        deputyManagementObj['status'] = 'delete';
                        deputyManagementObj['field'] = 'management';
                        deputyManagements.push(deputyManagementObj);
                    }
                }

                deputyManagementElements = $(".new-item");

                for (var item of deputyManagementElements) {
                    deputyManagementObj = {};
                    deputyManagementObj['id'] = JSON.stringify(null);
                    deputyManagementObj['data'] = $(item).find("input").first().val()
                    deputyManagementObj['status'] = 'add';
                    deputyManagementObj['field'] = 'management';
                    deputyManagements.push(deputyManagementObj);
                }
                //#endregion
                //#endregion

                data.list = data.list.concat(deputyManagements);
                // data.managements = deputyManagements;
                // data.publish = JSON.stringify(true);

                console.log(data);
                console.log(data.list);

                if (data.list.length == 0){
                    var redirectURL = '{% url "master_data:deputy_list_page" %}';
                    setTimeout(function () {
                        location.replace(redirectURL);
                    }, 1500)
                    return;
                }

                $.ajax(
                    {
                        method: 'POST',
                        url: '{% url "master_data:ajax_edit_deputy" %}',
                        data: {
                            content: JSON.stringify(data),
                            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                        },
                        success: function (json) {
                            if (json.status == '200') {
                                $(".blur").removeClass('active');
                                $(".loading-fixed").hide();
                                $("html, body").animate({
                                    scrollTop: $(".alert-section").offset().top - 20
                                }, 1000);
                                $(".alert-message.success-message").show();
                                $(".alert-message.error-message").hide();
                                var redirectURL = '{% url "master_data:deputy_list_page" %}';
                                setTimeout(function () {
                                    location.replace(redirectURL);
                                }, 1500)
                            }
                            else
                            {
                                $(".blur").removeClass('active disable-form');
                                $(".loading-fixed").hide();
                                $("html, body").animate({
                                    scrollTop: $(".alert-section").offset().top - 20
                                }, 1000);
                                $(".alert-message-text.error-text").html(json.error + ' ' + '(' + json.status + ')');
                                $(".alert-message.error-message").show();
                            }
                        },
                        error: function (json, status, xhr) {
                            //   console.log(json.responseJSON.error);
                            console.log(json);
                            console.log(status);
                            console.log(xhr);
                            $(".blur").removeClass('active disable-form');
                            $(".loading-fixed").hide();
                            $("html, body").animate({
                                scrollTop: $(".alert-section").offset().top - 20
                            }, 1000);
                            $(".alert-message-text.error-text").html(xhr + ' ' + '(' + status + ')');
                            $(".alert-message.error-message").show();
                        }
                    }
                )
            }
            else
            {
                $("html, body").animate({
                    scrollTop: $(".alert-section").offset().top - 20
                }, 1000);
            }
        })
	//#endregion
    </script>

</body>

</html>